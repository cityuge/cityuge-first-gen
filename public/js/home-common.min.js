var config = {
	// Twitter Bootstrap responsive grid breakpoints.
	grid: {
		smMin: 768,
		mdMin: 992,
		lgMin: 1200
	},
	// Social media share pop-up sizes.
	socialMedia: {
		facebook: {
			width: 520,
			height: 350
		},
		twitter: {
			width: 550,
			height: 420
		},
		googlePlus: {
			width: 500,
			height: 380
		},
		renren: {
			width: 626,
			height: 436
		},
		sinaWeibo: {
			width: 607,
			height: 523
		}
	}
};
var lang = (function() {
	var zhHK = {
		'category.AREA1': 'Area 1',
		'category.AREA2': 'Area 2',
		'category.AREA3': 'Area 3',
		'category.UNIREQ': '大學必修',
		'category.E': '補底班'
	};

	var en = {
		'category.AREA1': 'Area 1',
		'category.AREA2': 'Area 2',
		'category.AREA3': 'Area 3',
		'category.UNIREQ': 'Uni. Req.',
		'category.E': 'Foundation'
	};

	return {
		get: function(key) {
			var locale = $('html').attr('lang');
			if (locale === 'zh-HK') {
				return zhHK[key];
			} else if (locale === 'en') {
				return en[key];
			} else {
				return '???';
			}
		}
	}
})();
var headerQuickSearch = (function() {
	var typeahead = null;
	var $input = null;
	var courses = new Bloodhound({
		datumTokenizer: function(d) {
			return d.tokens;
		},
		queryTokenizer: Bloodhound.tokenizers.whitespace,
		limit: 5,
		prefetch: {
			url: APP_BASE_URL + '/web-api/courses/typeahead'
		}
	});
	var template = '<span class="course-code"><%- value %></span>'
			+ '<span class="course-title"><%- title %></span>'
			+ '<span class="course-category label label-category-<%- category.toLowerCase() %>"><%- lang.get("category." + category) %></span>';

	return {
		init: function() {
			courses.initialize();

			$input = $('#header-quick-search input[type="text"]');

			if ($(window).width() >= config.grid.smMin) {
				this.enableTypeahead();
			}

			// Disable the typeahead if the navbar is collapsed, reenable it when the navbar does not collasped
			var that = this;
			$(window).resize(_.throttle(function() {
				if ($(window).width() >= config.grid.smMin) {
					if (typeahead === null) {
						that.enableTypeahead();
					}
				} else {
					if (that.typeahead !== null) {
						that.disableTypeahead();
					}
				}
			}, 800));
		},
		enableTypeahead: function() {
			typeahead = $input.typeahead({
				hint: true,
				minLength: 1
			},
			{
				name: 'quick-search-courses',
				displayKey: 'value',
				source: courses.ttAdapter(),
				templates: {
					suggestion: _.template(template)
				}
			});

			// Navigate to the course info page directly when user selected an item in typeahead
			typeahead.on('typeahead:selected',function(event, data){
				var courseCode = data.value.toLowerCase();
				window.location = APP_BASE_URL + '/courses/' + courseCode;
			});
		},
		disableTypeahead: function() {
			$input.typeahead('destroy');
			typeahead = null;
		}
	}
})();
var comment = (function() {
	var socialMediaLink = function() {
		$('ul[data-share-list] a').click(function(e) {
			e.preventDefault();
			$el = $(this);
			window.open($el.attr('href'), '', socialMediaPopUpSpec($el.attr('data-share')));
		});
	}
	var socialMediaPopUpSpec = function(mediaKey) {
		var socialMedia = config.socialMedia[mediaKey];
		return 'scrollbars=yes,resizable=yes,toolbar=no,location=yes,width=' + socialMedia.width
				+ ',height=' + socialMedia.height
				+ ',left=' + ((screen.width - socialMedia.width) / 2)
				+ ',top=' + ((screen.height - socialMedia.height) / 2);
	}

	return {
		initMasonry: function() {
			new Masonry('#comment-container', {
				transitionDuration: 0,
				itemSelector: '.comment-wrapper',
				columnWidth: '.comment-wrapper-dummy'
			});
		},
		initComment: function() {
			socialMediaLink();
			$('[data-toggle="tooltip"]').tooltip();
		}
	}
})();